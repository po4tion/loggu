name: Auto Label PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Analyze commits and add labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // PRì˜ ëª¨ë“  ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            console.log(`Found ${commits.length} commits in PR`);

            const labelMap = {
              'feat': 'feature',
              'fix': 'bug',
              'docs': 'documentation',
              'style': 'style',
              'refactor': 'refactor',
              'perf': 'performance',
              'test': 'test',
              'chore': 'chore',
              'hotfix': 'hotfix',
              'ui': 'UI/UX',
              'security': 'security',
              'release': 'release'
            };

            const emojiMap = {
              'âœ¨': 'feature',
              'ğŸ›': 'bug',
              'ğŸ“š': 'documentation',
              'ğŸ’': 'style',
              'â™»ï¸': 'refactor',
              'âš¡': 'performance',
              'âœ…': 'test',
              'ğŸ”§': 'chore',
              'ğŸš¨': 'hotfix',
              'ğŸ¨': 'UI/UX',
              'ğŸ”': 'security',
              'ğŸš€': 'release'
            };

            // ë¼ë²¨ ì¶”ì¶œ í•¨ìˆ˜
            const labelsToAdd = new Set();

            function analyzeText(text) {
              // ì´ëª¨ì§€ ê°ì§€
              for (const [emoji, label] of Object.entries(emojiMap)) {
                if (text.includes(emoji)) {
                  labelsToAdd.add(label);
                }
              }

              // íƒ€ì… ê°ì§€ (ì˜ˆ: "feat:", "fix:", "release:" ë“±)
              const typeMatch = text.match(/^\s*(?:[\p{Emoji}]\s+)?(\w+):/u);
              if (typeMatch) {
                const type = typeMatch[1];
                if (labelMap[type]) {
                  labelsToAdd.add(labelMap[type]);
                }
              }
            }

            // PR ì œëª© ë¶„ì„ (release: ë“±)
            const prTitle = context.payload.pull_request.title;
            console.log(`Analyzing PR title: ${prTitle}`);
            analyzeText(prTitle);

            // ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„
            commits.forEach(commitData => {
              const message = commitData.commit.message;
              if (!message) return;

              // ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ì¤„(ì œëª©)ë§Œ ë¶„ì„
              const firstLine = message.split('\n')[0];
              console.log(`Analyzing commit: ${firstLine}`);
              analyzeText(firstLine);
            });

            if (labelsToAdd.size === 0) {
              console.log('No labels to add based on PR title and commit messages');
              return;
            }

            // ë¼ë²¨ ì¶”ê°€
            const labels = Array.from(labelsToAdd);
            console.log(`Adding labels: ${labels.join(', ')}`);

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              console.log('Labels added successfully');
            } catch (error) {
              console.log(`Warning: Some labels might not exist in the repository.`);
              console.log(`Error: ${error.message}`);
              console.log('Please ensure the following labels exist in your repository:');
              console.log(labels.join(', '));
            }
